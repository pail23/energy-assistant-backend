# Energy Assistant Configuration file

The `energy_assistant.yaml` file is used to configure Energy Assistant. An starting point for your configuration file can be found [here](https://raw.githubusercontent.com/pail23/energy-assistant-backend/main/energy_assistant.yaml.dist).

# Home

Configure the main attributes of your home.

The following values need to be set (not optional):

- `name`: The name of the home to be displayed in the user interface.
- `solar_power`: Home Assistant entity name for the currently produced solar power.
- `solar_energy`: Home Assistant entity name for the total amount of solar energy produced by the house. Optionally this value can be generated by the integration helper in Home Assistant.
- `grid_supply_power`: Home Assistant entity name for the current power measured at the connection point of the house to the grid. This value can be positive (exporting energy to the grid) or negative (importing energy from the grid).
- `grid_inverted`: If set to True, you can invert the `grid_supply_power`.
- `imported_energy`: Home Assistant entity name for the total amount of energy imported from the grid.
- `exported_energy`: Home Assistant entity name for the total amount of energy imported from the grid.

## Devices

This is a list of the devices to monitored and managed by the Energy Assistant.

- `name`: The name of the device to be displayed in the user interface.
- `id`: GUID of the device. This value needs to be a valid guid and needs to be unique.
- `type`: This can either be `evcc`, `power-state-device`, `homeassistant` or `stiebel-eltron`
- `store_sessions`: Needs to be set to true in case you want to log the sessions of the devie in the Session Log.
- `energy_scale`: In case the device does provide the total energy in other units than kWh, this is the conversion factor (e.g. 0.001 in case the energy is provided in Wh.)

### `evcc` type

This is a device (e.g. a charger) managed by Evcc. You need to configure a MQTT connection for the Evcc connect.

- `evcc_topic`: The mqtt topic configured in the [Evcc MQTT Configuration](https://docs.evcc.io/docs/reference/configuration/mqtt).
- `load_point_id`: The Evcc id of the load point (typically the ids are just numbers from 1..x)

### `homeassistant` type

This is a device managed by Home Assistant. Energy Assistant will display the current power consumption and provides different statistics on energy consumption like self sufficiency.

In case you are setting the `model` and `manufaturer` or the `state`, the device will detect it's state (`on` or `off`) based on the power consumption. This state information can then be used to log the sessions of the device (in case `store_sessions` is set to `True`). Example: You have a dish washer connected through a smart plug. This device type the detects if the dishwasher is running or not.

- `icon`: mdi icon shown in the UI
- `power`: Home Assistant entity for the current power consumtion of the device (in Watt)
- `energy`: Home Assistant entity for the total energy meter of the device (in kWh). In case the device does not provide this entity, you can setup a integration helper in Home Assistant.
- `energy_scale`: (optional) This value can be used to convert the energy meter value into kWh. Example: In case the value is provided in Wh in Home Assistant, set this value to 0.001
- `manufacturer`: Manufacturer of the device.
- `model`: Model of the device
- `output`: In case you want Energy Assistant to control the device (pv mode or optimized mode), you need to set this value to the id of the homeassistant switch entity controlling the power of the device.
- `nominal_power`: Expected nominal power consumption (in Watts) of the device in case the device is running.
- `nominal_duration`: Expected nominal time (in seconds) the device is running per day.
- `constant`: `True` if the power of the device should not be interrupted when the device is running. In this case, there is only one startup per 24h in the `Optimized` mode.

- `state`: In case Energy Assistant has not yet a pre-configured [model](device_models.md) of your device, you can configure the state detection with this entry.
  - `state_on`:
    - `threshold`: The device is detected as `on` when the power goes above this value (in Volt)
  - `state_off`:
    - `threshold`: The device is detected as `off` when the power goes above this value (in Volt). In addition the following items are considered:
    - `trailing_zeros_for`: The power needs to be below `threshold` for `trailing_zeros_for` seconds.

In case neither `manufacturer` or `model` nor `state` is defined, the following defaults are used:

- Device is `on` if power is above 2 Watt
- Device is `off` if power is 0 Watt for 10 seconds

Energy Assistant is providing detection for the device types listed [here](device_models.md).

### `stiebel-eltron` type

This device type is used for Stiebel Eltron heat pumps. Often, you will configure two instances: One for heating, one for water heating.

- `state`: Home Assistant entity for the state of the device (`on` or `off`)
- `energy_today`: Home Assistant entity for total energy used today
- `energy_total`: Home Assistant entity for total energy used (before today)
- `temperature`: Home Assistant entity for the current temperature
- `comfort_target_temperature`: Home Assistant entity for the target temperature
- `target_temperature_normal`: Target temperature for normal operation
- `target_temperatrure_pv`: Target temperature for the case when enough PV power is available or the timeslot for the Optimized Energy consumption is now.

## Example:

```
home:
  name: "My Home"
  solar_power: sensor.solaredge_i1_ac_power
  solar_energy: sensor.solaredge_i1_ac_energy_kwh
  grid_supply_power: sensor.solaredge_m1_ac_power
  imported_energy: sensor.solaredge_m1_imported_kwh
  exported_energy: sensor.solaredge_m1_exported_kwh
  devices:
    - name: Evcc loadpoint 1
      id: 7d480adc-2c45-4de9-8f36-063c5dea0253
      type: evcc
      evcc_topic: "evcc"
      load_point_id: 1
      store_sessions: true
    - name: Tumbler
      id: 75203c88-216f-4712-8a94-80513793f7e1
      type: power-state-device
      power: sensor.tumbler_power
      energy: sensor.tumbler_energy
      energy_scale: 0.001
      store_sessions: true
      manufacturer: v-zug
      model: Adora TS WP
    - name: Server
      id: eb6b3f0a-1175-4ff3-9ebe-8c22663cba48
      type: homeassistant
      icon: mdi-server-network
      power: sensor.server_power
      energy: sensor.server_energy
      energy_scale: 0.001
```

# Mqtt

The mqtt configuration is only needed in case you would like to interface with [evcc](https://evcc.io/).

Example:

```
mqtt:
  host: homeassistant.stadel15.net
  username: smarthome
  password: smarthome!23
  topic: energyassistant
```

# Emhass

The Emhass configuration section is described in the [Emhass documentation](https://emhass.readthedocs.io/en/latest/config.html).

The following keys in the Emhass configuration are provided by Energy Assistant itself. In case you are using those keys, Energy Assistant will overwrite the values:

- hass_url
- long_lived_token
- var_PV
- var_load
- var_replace_zero
- var_interp
- time_zone
- lat
- lon
- alt

- num_def_loads
- P_deferrable_nom
- def_total_hours
- treat_def_as_semi_cont
- set_def_constant

# Home Assistant

This section is only used in case you run Energy Assistant stand alone (not as Home Assistant addon).

- `url`: URL of the home assistant instance you want to connect to.
- `token`: [Long lived access token](https://www.home-assistant.io/docs/authentication/) from Home Assistant.

Example:

```
homeassistant:
  url: https://homeassistant.example.net
  token: "your long lived home assistant token"
```
